<script src="https://code.jquery.com/jquery-latest.js"></script>
<link rel="stylesheet" type="text/css" href="slideControl.css" />
<script type="text/javascript" src="jquery.slideControl.js"></script>
<header class="container">
    <a href="#" class="logo"><img src="" alt=" "></a>
    <!-- <a href="#">log in</a> -->
    <div id="login">Log In</div>
    <div id="status">status</div>
    <div id="logout">Log Out</div>
    
<link rel="stylesheet" href="./add_post.css"> <!-- 변경사항-->

</header>
<body>
    <!--search-->
    <section class="Search_bar_section">  
        <form action="search_tag()">
            <input type="text" placeholder = "input tag" name="keyword">
            <input type="submit" value="search">
        </form>    
    </section> 
            
    <section class ="Tag_section">
    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/5.10.1/firebase-app.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/5.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.10.1/firebase-firestore.js"></script>
    <script src="./init-firebase.js"></script>

    <script src="js/bootstrap.js"></script>
    <link rel="stylesheet" href="css/bootstrap.css">


    <script type="text/javascript">

    var provider2 = new firebase.auth.GoogleAuthProvider();

    var dummy = [];
    var comment_postid;
    $(document).ready(function(){
        
        $.ajax({
            method: "GET",
            url: "http://106.10.34.9:3000/main_page",
            data: {}
        }).done( function (data) {
            console.log(dummy);
            let contentsHTML = '';
            data[1].forEach(o => { 
                // if (o.tag == app) return;
                contentsHTML += `
                <div>
                    <div class="post" data-postid="${o['post_id']}" data-url="${o['og:url']}">
                        <div>
                            ${o['og:title']}
                        </div>
                        <div>
                            ${o['og:description']}
                        </div>
                        <div>
                            <img src="${o['og:image']}">
                        </div>
                    </div>
                    <div>
                       level :  ${o['level']/o['level_count']}

                    </div>
                </div>
                `;
            });
            $('#contents').html(contentsHTML);
            $(".post").click(function() {
                //새창 띄우고
                window.open(this.dataset.url);

                //모달 띄우고
                console.log(this.dataset.postid);
                comment_postid = this.dataset.postid;
                $('#comment_modal').modal('show');
            });
            $(".check").click(function(){  
                var str = ""; 
                $(".check").each(function(){  
                    if($(this).is(":checked"))  
                        str += $(this).val() + " "; 
                });
              $("#Multi").text(str);  // #multiPrint에 체크된 원소를 출력한다.
             
            });
            $("#login").click(() => {
                firebase.auth().signInWithPopup(provider2).then(function(result) {
                    console.log("333...")
                    // This gives you a GitHub Access Token. You can use it to access the GitHub API.
                    var token = result.credential.accessToken;
                    // The signed-in user info.
                    var user = result.user;
                    // ...
                    console.log(token);
                    console.log(user);
                }).catch(function(error) {
                // Handle Errors here.
                var errorCode = error.code;
                var errorMessage = error.message;
                // The email of the user's account used.
                var email = error.email;
                // The firebase.auth.AuthCredential type that was used.
                var credential = error.credential;
                // ...
                });
            });
            $("#status").click(() => {
                firebase.auth().onAuthStateChanged(function(user) {
                    if (user) {
                        // User is signed in.
                        var displayName = user.displayName;
                        var email = user.email;
                        var emailVerified = user.emailVerified;
                        var photoURL = user.photoURL;
                        var isAnonymous = user.isAnonymous;
                        var uid = user.uid;
                        var providerData = user.providerData;
                        // ...
                        console.log(user);
                    } else {
                        // User is signed out.
                        // ...
                        console.log('nono')
                    }
                });

            });
            $("#logout").click(() => {
                firebase.auth().signOut().then(function() {
                    console.log("Sign-out successful")
                }).catch(function(error) {
                    console.log("An error happened.")
                });
            })
        });
    });

    //태그받아오기
    function get_tags() {
        $.ajax({
            method: "GET",
            url: "http://106.10.34.9:3000/analysis_url",    //태그 url 수정
            data: {}
        })
            .done(function (data) {
                let tagsHTML = '';
                data.forEach(o => {
                    tagsHTML += `
                    <div id="${o.tags}">
                         ${o.tags}                  
                    </div>
                 `;                
                })
            });
        $('#tags').html(tagsHTML);
    }
    function search_tag(){

    }
    </script>
    <!--tag-->
    <details>
            <summary onclick="get_tags()">Tag</summary>  
            <div id="tags">
            </div>
            <span id="Multi"></span>
        </details>
        
    </section>


    <!--view-->
    <div id="contents">
        
    </div>

    <!-- Button trigger modal -->
    <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal">
    Launch demo modal
  </button>
    <!------------------------------------->
    
<script>
function url_focusout() {
        const m_name = $('#url').val();
        console.log(m_name)
        $.ajax({
            method: "GET",
            url: "http://106.10.34.9:3000/analysis_url",
            data: { url: m_name }
        })
            .done(function (data) {
                console.log(data);
                blog_data = data;
                // $('#image').text(data['og:image'])
                $("#image").attr("src", data['og:image']);
                $('#description').text(data['og:description'])
                //alert("Data Saved: " + data);
            });
    }
    //tag


    $(function () {
        var sampleTags = ['c++', 'java', 'php', 'coldfusion', 'javascript', 'asp', 'ruby', 'python', 'c', 'scala', 'groovy', 'haskell', 'perl', 'erlang', 'apl', 'cobol', 'go', 'lua'];

        //-------------------------------
        // Tag events
        //-------------------------------
        var eventTags = $('#eventTags');

        var addEvent = function (text) {
            $('#events_container').append(text + '<br>');
        };

        eventTags.tagit({
            availableTags: sampleTags,
            beforeTagAdded: function (evt, ui) {
                if (!ui.duringInitialization) {
                    addEvent('beforeTagAdded: ' + eventTags.tagit('tagLabel', ui.tag));
                }
            },
            afterTagAdded: function (evt, ui) {
                if (!ui.duringInitialization) {
                    addEvent('afterTagAdded: ' + eventTags.tagit('tagLabel', ui.tag));
                }
            },
            beforeTagRemoved: function (evt, ui) {
                addEvent('beforeTagRemoved: ' + eventTags.tagit('tagLabel', ui.tag));
            },
            afterTagRemoved: function (evt, ui) {
                addEvent('afterTagRemoved: ' + eventTags.tagit('tagLabel', ui.tag));
            },
            onTagClicked: function (evt, ui) {
                addEvent('onTagClicked: ' + eventTags.tagit('tagLabel', ui.tag));
            },
            onTagExists: function (evt, ui) {
                addEvent('onTagExists: ' + eventTags.tagit('tagLabel', ui.existingTag));
            }
        });
        //-------------------------------
        // Remove confirmation
        //-------------------------------
        $('#removeConfirmationTags').tagit({
            availableTags: sampleTags,
            removeConfirmation: true
        });

    });
    var blog_data;
function send_data(){
    var level = document.getElementById('level').value;
    var m_client_id = 'test_id';
    var tags = {};

    
    var i=0;
    while(1){
        try {
            tags[document.getElementsByClassName("tagit-label")[i].innerHTML]=true;
        } catch {
            console.log(tags, 'eror!')
            break;
        }
        // if(document.getElementsByClassName("tagit-label")[i].innerHTML==null) break;
        // tags[document.getElementsByClassName("tagit-label")[i].innerHTML]=true;
        i++;
    }
    console.log(tags);
    
    console.log(blog_data);
    $.ajax({
            method: "POST",
            url: "http://106.10.34.9:3000/write_post",
            data: {
                'client_id' : m_client_id, 
                'og:title' : blog_data['og:title'],
                'og:description' :blog_data['og:description'],
                'og:image': blog_data['og:image'],
                'og:url': blog_data['og:url'],
                'level' : level,
                'tags' :  tags}
    }).done((data) => {
        console.log(data);
    });
}

</script>
<!-- 2 CSS files are required: -->
<!--   * Tag-it's base CSS (jquery.tagit.css). -->
<!--   * Any theme CSS (either a jQuery UI theme such as "flick", or one that's bundled with Tag-it, e.g. tagit.ui-zendesk.css as in this example.) -->
<!-- The base CSS and tagit.ui-zendesk.css theme are scoped to the Tag-it widget, so they shouldn't affect anything else in your site, unlike with jQuery UI themes. -->
<link href="css/jquery.tagit.css" rel="stylesheet" type="text/css">
<link href="css/tagit.ui-zendesk.css" rel="stylesheet" type="text/css">
<!-- If you want the jQuery UI "flick" theme, you can use this instead, but it's not scoped to just Tag-it like tagit.ui-zendesk is: -->
<!--   <link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1/themes/flick/jquery-ui.css"> -->

<!-- jQuery and jQuery UI are required dependencies. -->
<!-- Although we use jQuery 1.4 here, it's tested with the latest too (1.8.3 as of writing this.) -->
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/jquery-ui.min.js" type="text/javascript"
    charset="utf-8"></script>
<script src="js/tag-it.js" type="text/javascript" charset="utf-8"></script>

<!-- Modal -->
 <!-- The Modal -->
 <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">

            <div class = "modal-head">
            <div class="new">NEW
             <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
        </div>

           <div id="url_box"> URL 
                <input type="text" id="url" onfocusout="url_focusout()"> 
            </div>
        
        <!--tag--> <div id="tag_box">TAG
             <ul id="removeConfirmationTags"> <li>tag</li>  </ul>
            </div>

        <!--slider-->
        <div class="content">
            <label id="level_box"> level</label><input type="text" value="6.0" class="slideControl" maxlength="3" name="level" id="level"/>
        </div>
       
        <table id="table_box">
                <tr data-href="www.naver.com" style="cursor:pointer;">
                    <td><img src="#" id='image'></td>
                </tr>
                <tr data-href="www.naver.com" style="cursor:pointer;">
                    <td id='description'>description</td>
                </tr>
        </table>

        <div id="submit_box">
            <input type="button" value="submit" style="color:#ffffff; font-family: NanumSquareB; font-size:12px;"
            onclick="send_data()" data-dismiss="modal" aria-label="Close" id="submit_button">
        </input>
        </div>

    </div>
</div>
</div>
</div>
<!------------------------------------------------------------------------>
<!-- Modal -->
 <!-- The Modal -->
 <div class="modal fade" id="comment_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
             <div class="modal-header">
                 <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                  <!--slider-->
                <div class="content">
                    <label>level: </label><input type="text" value="6.0" class="slideControl" maxlength="3" id="comment_level" />
               </div>
    
                <div class = "comment">
                comment
                <textarea name="comment_box" id = "comment" rows = "5" cols="50"> </textarea>
                </div>
                <input type="button" value="submit" onclick="send_comment_data()" data-dismiss="modal" aria-label="Close"></input>
            </div>
        </div>
    </div>
</div>

    <!-- scripts -->
<script type="text/javascript"> 
     jQuery(document).ready(function () {
        $('table tr').click(function () {
            window.open($(this).data('href'));
        });
        //slider
        $('.slideControl').slideControl();
    });

    function send_comment_data () {
       var level = document.getElementById('comment_level').value;
       var m_client_id = 'test_id';
       var m_com = $('#comment').val();
   
       console.log(m_com);
       console.log(level);
   
       $.ajax({
           method : "POST",
           url : "http://106.10.34.9:3000/feedback_post",
           data : { 
               'client_id' : m_client_id,
               'post_id' : '1E45XGW6k0qiWhWJwnfE',
               'level' : level ,
               'comment' : m_com   }
           }).done((data) => {
               console.log(data);
       });
    }
   </script>
</body>